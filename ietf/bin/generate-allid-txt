#!/usr/bin/env python

from django.template.loader import render_to_string

from ietf.idtracker.models import IDInternal
from ietf.idtracker.models import InternetDraft
from ietf.idtracker.models import IDStatus


# This block feels to me like it still knows _way_ too much about the insides of the model - should all of it be moved into the model itself?
# select_related actually causes the wrong thing to happen because of reference problems in the tables
#all_ids            = InternetDraft.objects.order_by('filename').select_related(depth=1)
all_ids            = InternetDraft.objects.order_by('filename')
in_track_ids       = all_ids.filter(idinternal__rfc_flag=0).exclude(idinternal__cur_state__in=IDInternal.INACTIVE_STATES)
exclude_ids        = [item.id_document_tag for item in in_track_ids]
not_in_track       = all_ids.exclude(id_document_tag__in=exclude_ids)
active             = not_in_track.filter(status__status_id=IDInternal.ACTIVE)
published          = not_in_track.filter(status__status_id=IDInternal.PUBLISHED)
expired            = not_in_track.filter(status__status_id=IDInternal.EXPIRED)
withdrawn_submitter = not_in_track.filter(status__status_id=IDInternal.WITHDRAWN_SUBMITTER)
withdrawn_ietf      = not_in_track.filter(status__status_id=IDInternal.WITHDRAWN_IETF)
replaced           = not_in_track.filter(status__status_id=IDInternal.REPLACED)

# If all of that moved, then this file would just be the following line, with, for example, the bare
# in_track_ids turned into something like InternetDraft.in_track_ids()

print render_to_string("idindex/all_ids.txt",{  'in_track_ids':in_track_ids,
						'active':active,
						'published':published,
						'expired':expired,
						'withdrawn_submitter':withdrawn_submitter,
						'withdrawn_ietf':withdrawn_ietf,
						'replaced':replaced})
