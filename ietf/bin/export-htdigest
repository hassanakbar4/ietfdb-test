#!/usr/bin/env python
#
from django.core.exceptions import ObjectDoesNotExist
from ietf.ietfauth.models import LegacyLiaisonUser, LegacyWgPassword
from ietf.idtracker.models import IESGLogin

output = {}

# we use pseudo-polymorphism to get through all of these objects.
for p in list( IESGLogin.objects.all() ) + \
	 list( LegacyLiaisonUser.objects.all() ) + \
	 list( LegacyWgPassword.objects.all() ):
    # Bad rows in these tables use bad references.
    if p.person_id == 0 or p.person_id == 999999 or p.person_id == 888888:
	continue
    # Skip if we've already output this person
    if p.login_name in output:
        continue
    output[ p.login_name ] = 1
    if p.person.usermap_set.count() != 1:
	print "# Can't find user mapping for %s" % p.login_name
	continue
    usermap = p.person.usermap_set.all()[0]
    u = usermap.user
    ( algo, salt, hsh ) = u.password.split( '$' )
    if algo != 'htdigest':
	continue
    if p.login_name == u.username:
        print "%s:IETF:%s" % ( u.username, hsh )
    elif p.login_name == u.email:
        print "%s:IETF:%s" % ( u.email, usermap.email_htdigest )
    else:
        print "# Can't find user mapping for %s (%s/%s)" % ( p.login_name, u.username, u.email )
