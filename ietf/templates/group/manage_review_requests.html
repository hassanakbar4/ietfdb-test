{% extends "base.html" %}
{# Copyright The IETF Trust 2015, All Rights Reserved #}
{% load origin %}{% origin %}

{% load ietf_filters staticfiles bootstrap3 %}

{% block title %}Manage pending review requests for {{ group.acronym }}{% endblock %}

{% block pagehead %}
  <link rel="stylesheet" href="{% static "jquery.tablesorter/css/theme.bootstrap.min.css" %}">
{% endblock %}

{% block content %}
  {% origin %}

  <h1>Manage open review requests for {{ group.acronym }}</h1>

  <p>For reference: <a href="{% url "ietf.group.views.review_requests" group_type=group.type_id acronym=group.acronym %}#closed-review-requests">closed review requests</a>

  {% if review_requests %}
    <form class="review-requests" method="post">{% csrf_token %}
      <table class="table table-condensed table-striped materials">
        <thead>
          <tr>
            <th>Document</th>
            <th>Type</th>
            <th>Requested</th>
            <th>Deadline</th>
            <th>Reviewer</th>
            <th>Close as...</th>
          </tr>
        </thead>
        <tbody>
          {% for r in review_requests %}
            <tr>
              <td><a href="{% if r.requested_rev %}{% url "doc_view" name=r.doc.name rev=r.requested_rev %}{% else %}{% url "doc_view" name=r.doc.name %}{% endif %}">{{ r.doc.name }}{% if r.requested_rev %}-{{ r.requested_rev }}{% endif %}</a>
                {% if r.latest_reqs %}
                  <br>
                  <small>- prev. review:
                    {% for rlatest in r.latest_reqs %}
                      <a href="{% url "ietf.doc.views_review.review_request" name=rlatest.doc_id request_id=rlatest.pk %}">{{ rlatest.result.name }}</a>
                      (<a href="{{ rfcdiff_base_url }}?url1={{ rlatest.doc.name }}-{{ rlatest.reviewed_rev }}&url2={{ r.doc.name }}-{{ r.doc.rev }}">diff</a>){% if not forloop.last %},{% endif %}
                    {% endfor %}
                  </small>
                {% endif %}
              </td>
              <td>{{ r.type.name }}</td>
              <td>{% if r.time %}{{ r.time|date:"Y-m-d" }}{% else %}<em>auto-suggested</em>{% endif %}</td>
              <td>
                {{ r.deadline|date:"Y-m-d" }}
                {% if r.due %}<span class="label label-warning">{{ r.due }} day{{ r.due|pluralize }}</span>{% endif %}
              </td>
              <td>
                {% if r.reviewer %}
                  <button type="button" class="btn btn-default btn-sm reviewer-action" title="Click to reassign request">{{ r.reviewer.person }} {% if r.state_id == "accepted" %}<span class="label label-default">accp</span>{% endif %}</button>
                {% else %}
                  <button type="button" class="btn btn-default btn-sm reviewer-action" title="Click to assign request"><em>not yet assigned</em></button>
                {% endif %}

                {{ r.form.action }}

                <span class="reviewer-controls form-inline">
                  {% spaceless %}
                    {{ r.form.reviewer }}
                    <button type="button" class="btn btn-default btn-sm undo" title="Undo assignment"><span class="fa fa-times"></span></button>
                    {% if r.form.reviewer.errors %}
                      <br>
                      {{ r.form.reviewer.errors }}
                    {% endif %}
                  {% endspaceless %}
                </span>
              </td>
              <td>
                <button type="button" class="btn btn-default btn-sm close-action">Close...</button>

                <span class="close-controls form-inline">
                  {% spaceless %}
                    {{ r.form.close }}
                    <button type="button" class="btn btn-default btn-sm undo" title="Undo closing"><span class="fa fa-times"></span></button>
                    {% if r.form.close.errors %}
                      <br>
                      {{ r.form.close.errors }}
                    {% endif %}
                  {% endspaceless %}
                </span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% buttons %}
        <a href="{% url "ietf.group.views.review_requests" group_type=group.type_id acronym=group.acronym %}" class="btn btn-default pull-right">Cancel</a>
        <button class="btn btn-primary" type="submit">Save changes</button>
      {% endbuttons %}
    </form>
  {% else %}
    <p>There are currently no open requests.</p>
  {% endif %}
{% endblock %}

{% block js %}
  <script src="{% static "jquery.tablesorter/js/jquery.tablesorter.combined.min.js" %}"></script>
  <script src="{% static "ietf/js/manage-review-requests.js" %}"></script>
{% endblock %}
